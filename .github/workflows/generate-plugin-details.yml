name: Generate Plugin Details

on:
  push:
    branches:
      - main
    paths:
      - 'plugins.json'
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-details:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Generate plugin details
        run: |
          node <<'EOL'
          const fs = require('fs');
          const https = require('https');

          async function main() {
            try {
              const plugins = JSON.parse(fs.readFileSync('plugins.json', 'utf8'));
              console.log(`åœ¨ plugins.json ä¸­æ‰¾åˆ° ${plugins.length} ä¸ªæ’ä»¶`);

              // è·³è¿‡ç¬¬ä¸€ä¸ªæ’ä»¶
              const pluginsToProcess = plugins.slice(1);
              console.log(`å‡†å¤‡å¤„ç† ${pluginsToProcess.length} ä¸ªæ’ä»¶ï¼ˆè·³è¿‡ç¬¬ä¸€ä¸ªï¼‰`);

              const pluginDetails = [];
              const errors = [];

              for (const plugin of pluginsToProcess) {
                try {
                  console.log(`\n=== æ­£åœ¨è·å–æ’ä»¶æ¸…å•ï¼š${plugin.id} ===`);
                  console.log(`ä»“åº“åœ°å€ï¼š${plugin.repositoryUrl}`);
                  const manifest = await fetchManifest(plugin.repositoryUrl);
                  
                  pluginDetails.push({
                    id: plugin.id,
                    manifest: manifest
                  });
                  
                  console.log(`âœ… æˆåŠŸå¤„ç†æ’ä»¶ï¼š${plugin.id}`);
                } catch (error) {
                  const errorMsg = `æ’ä»¶ ${plugin.id} å¤„ç†å¤±è´¥ï¼š${error.message}`;
                  console.error(`âŒ ${errorMsg}`);
                  errors.push(errorMsg);
                  // ç»§ç»­å¤„ç†å…¶ä»–æ’ä»¶ï¼Œä¸ä¸­æ–­æ•´ä¸ªæµç¨‹
                }
              }

              // å†™å…¥ plugin_details.json æ–‡ä»¶
              fs.writeFileSync('plugin_details.json', JSON.stringify(pluginDetails, null, 2));
              console.log(`\nâœ… ç”Ÿæˆ plugin_details.json æ–‡ä»¶ï¼ŒåŒ…å« ${pluginDetails.length} ä¸ªæ’ä»¶`);

              // æŠ¥å‘Šé”™è¯¯ç»Ÿè®¡
              if (errors.length > 0) {
                console.warn(`\nâš ï¸  å¤„ç†è¿‡ç¨‹ä¸­å‘ç° ${errors.length} ä¸ªé”™è¯¯ï¼š`);
                errors.forEach((error, index) => {
                  console.warn(`${index + 1}. ${error}`);
                });
                console.warn(`\næˆåŠŸç‡ï¼š${pluginDetails.length}/${pluginsToProcess.length} (${Math.round(pluginDetails.length / pluginsToProcess.length * 100)}%)`);
              } else {
                console.log(`\nğŸ‰ æ‰€æœ‰æ’ä»¶å¤„ç†æˆåŠŸï¼`);
              }

            } catch (error) {
              console.error(`âŒ å¤„ç†å¤±è´¥ï¼š${error.message}`);
              process.exit(1);
            }
          }

          function fetchManifest(repoUrl) {
            // Try multiple common branch names
            const branches = ['main', 'master', 'dev', 'develop'];
            
            async function tryFetchFromBranch(branch) {
              const rawUrl = repoUrl.replace('github.com', 'raw.githubusercontent.com') + `/refs/heads/${branch}/_manifest.json`;
              console.log(`å°è¯•ä» ${branch} åˆ†æ”¯è·å–æ¸…å•æ–‡ä»¶ï¼š${rawUrl}`);
              
              return new Promise((resolve, reject) => {
                const timeout = setTimeout(() => {
                  reject(new Error(`è·å–æ¸…å•æ–‡ä»¶è¶…æ—¶ï¼ˆ10ç§’ï¼‰ï¼š${rawUrl}`));
                }, 10000);

                const req = https.get(rawUrl, res => {
                  clearTimeout(timeout);
                  
                  if (res.statusCode !== 200) {
                    return reject(new Error(`çŠ¶æ€ç ï¼š${res.statusCode}`));
                  }
                  
                  let data = '';
                  res.on('data', chunk => data += chunk);
                  res.on('end', () => {
                    try {
                      const manifest = JSON.parse(data);
                      resolve({ manifest, branch, url: rawUrl });
                    } catch (parseError) {
                      reject(new Error(`JSON è§£æå¤±è´¥ï¼š${parseError.message}`));
                    }
                  });
                  res.on('error', err => {
                    clearTimeout(timeout);
                    reject(new Error(`è¯»å–å“åº”æ•°æ®æ—¶å‡ºé”™ï¼š${err.message}`));
                  });
                });

                req.on('error', err => {
                  clearTimeout(timeout);
                  reject(new Error(`ç½‘ç»œé”™è¯¯ï¼š${err.message}`));
                });

                req.setTimeout(10000, () => {
                  req.destroy();
                  reject(new Error(`è¯·æ±‚è¶…æ—¶`));
                });
              });
            }

            // Try each branch until one succeeds
            return (async () => {
              const errors = [];
              
              for (const branch of branches) {
                try {
                  const result = await tryFetchFromBranch(branch);
                  console.log(`âœ… æˆåŠŸä» ${result.branch} åˆ†æ”¯è·å–åˆ°æ¸…å•æ–‡ä»¶`);
                  return result.manifest;
                } catch (error) {
                  errors.push(`${branch} åˆ†æ”¯: ${error.message}`);
                  console.log(`âŒ ${branch} åˆ†æ”¯è·å–å¤±è´¥: ${error.message}`);
                }
              }
              
              // If all branches failed, throw a comprehensive error
              throw new Error(`æ— æ³•ä»ä»»ä½•åˆ†æ”¯è·å– _manifest.json æ–‡ä»¶ã€‚å°è¯•çš„åˆ†æ”¯ï¼š${branches.join(', ')}ã€‚é”™è¯¯è¯¦æƒ…ï¼š\n${errors.map((err, i) => `${i + 1}. ${err}`).join('\n')}ã€‚\n\nè¯·æ£€æŸ¥ï¼š\n1. æ–‡ä»¶åæ˜¯å¦ä¸º '_manifest.json'ï¼ˆæ³¨æ„ä¸‹åˆ’çº¿ï¼‰\n2. ä»“åº“æ˜¯å¦ä¸ºå…¬å¼€ä»“åº“\n3. æ–‡ä»¶æ˜¯å¦å­˜åœ¨äºä¸Šè¿°åˆ†æ”¯ä¸­\nä»“åº“åœ°å€ï¼š${repoUrl}`);
            })();
          }

          main();
          EOL

      - name: Commit and push plugin details
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add plugin_details.json
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
          else
            git commit -m "è‡ªåŠ¨ç”Ÿæˆ plugin_details.json"
            git push
            echo "âœ… å·²æäº¤å¹¶æ¨é€ plugin_details.json æ›´æ–°"
          fi
